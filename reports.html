<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Safety Analytics • ArborGen</title>
  <link rel="icon" type="image/png" href="icon.png" />
  <style>
    :root {
      --primary: #1a472a;
      --primary-dark: #0f2e1a;
      --primary-light: #2d6a4f;
      --secondary: #40916c;
      --accent: #52b788;
      --accent-light: #95d5b2;
      --bg: #f8fdf9;
      --card: #ffffff;
      --muted: #6c757d;
      --border: #e0e0e0;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --text: #212529;
      --text-light: #6c757d;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
      --radius: 8px;
    }

    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    button {
      cursor: pointer;
      font-family: inherit;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Header */
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.2px;
    }

    .user-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-badge {
      background: rgba(255, 255, 255, 0.15);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      transition: all 0.2s ease;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
    }

    .btn-outline:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Main Layout */
    main {
      padding: 24px 0 40px;
    }

    .dashboard {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 24px;
    }

    @media (max-width: 1024px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
    }

    /* Cards */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }

    .card-body {
      padding: 20px;
    }

    /* Sidebar */
    .filter-group {
      margin-bottom: 20px;
    }

    .filter-group:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text);
    }

    select, input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      background: white;
      color: var(--text);
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(82, 183, 136, 0.1);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
      border: none;
    }

    .btn-secondary:hover {
      background: var(--primary-light);
    }

    /* Charts */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    /* Data Table */
    .data-section {
      margin-top: 20px;
    }

    .table-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .table-actions {
      display: flex;
      gap: 8px;
    }

    .table-wrapper {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: auto;
      max-height: 500px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    th {
      background: #f8f9fa;
      padding: 12px 16px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      vertical-align: top;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .column-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .column-toggle input {
      width: auto;
    }

    /* Login */
    .login-container {
      max-width: 400px;
      margin: 80px auto;
      padding: 40px;
    }

    .login-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .login-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .login-subtitle {
      color: var(--muted);
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .status-message {
      padding: 12px;
      border-radius: 6px;
      margin-top: 16px;
      font-size: 14px;
    }

    .status-error {
      background: rgba(220, 53, 69, 0.1);
      color: var(--danger);
    }

    .status-success {
      background: rgba(40, 167, 69, 0.1);
      color: var(--success);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal {
      background: white;
      border-radius: var(--radius);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--muted);
      cursor: pointer;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .text-muted {
      color: var(--muted);
    }

    .mt-1 { margin-top: 8px; }
    .mt-2 { margin-top: 16px; }
    .mt-3 { margin-top: 24px; }
    .mb-1 { margin-bottom: 8px; }
    .mb-2 { margin-bottom: 16px; }
    .mb-3 { margin-bottom: 24px; }

    .flex {
      display: flex;
    }

    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .flex-center {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .gap-1 { gap: 8px; }
    .gap-2 { gap: 16px; }
  </style>
  <!-- Chart.js para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS para exportação Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

<header>
  <div class="container header-content">
    <div class="logo">
      <div class="logo-icon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L3 7V22H21V7L12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 22V12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M7 12H17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="logo-text">ArborGen Safety</div>
    </div>
    <div class="user-actions">
      <div id="user-badge" class="user-badge hidden">
        <span id="user-name"></span>
        <span id="user-role"></span>
      </div>
      <button id="btn-logout" class="btn btn-outline hidden">Sign Out</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- Login View -->
  <div id="view-login" class="card login-container">
    <div class="login-header">
      <div class="login-logo">
        <div class="logo-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L3 7V22H21V7L12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 22V12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M7 12H17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
      <h1 class="login-title">Safety Analytics</h1>
      <p class="login-subtitle">Access incident reports and analytics dashboard</p>
    </div>
    <div class="form-group">
      <label for="login-user">Username</label>
      <input type="text" id="login-user" autocomplete="username" placeholder="Enter your username">
    </div>
    <div class="form-group">
      <label for="login-pass">Password</label>
      <input type="password" id="login-pass" autocomplete="current-password" placeholder="Enter your password">
    </div>
    <button id="btn-login" class="btn btn-primary" style="width: 100%;">Sign In</button>
    <div id="login-status" class="status-message hidden"></div>
    <p class="text-muted text-center mt-3">
      Use your ArborGen credentials. All access is logged for security auditing.
    </p>
  </div>

  <!-- Dashboard View -->
  <div id="view-dash" class="hidden">
    <div class="dashboard">
      <!-- Sidebar Filters -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Report Filters</div>
        </div>
        <div class="card-body">
          <div class="filter-group">
            <label for="form-type">Report Type</label>
            <select id="form-type">
              <option value="employee_first">Employee Incident</option>
              <option value="supervisor_investigation">Supervisor Investigation</option>
              <option value="vehicle_accident">Motor Vehicle Accident</option>
              <option value="non_company_injury">Non-Company Injury</option>
              <option value="near_miss">Near-Miss Report</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="date-range">Date Range</label>
            <div class="flex gap-1">
              <input type="date" id="date-from" style="flex: 1;">
              <input type="date" id="date-to" style="flex: 1;">
            </div>
          </div>

          <div class="filter-group">
            <label for="location-filter">Location</label>
            <select id="location-filter">
              <option value="">All Locations</option>
              <!-- Will be populated dynamically -->
            </select>
          </div>

          <div class="filter-group">
            <label for="status-filter">Status</label>
            <select id="status-filter">
              <option value="">All Statuses</option>
              <option value="open">Open</option>
              <option value="closed">Closed</option>
              <option value="investigation">Under Investigation</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="severity-filter">Severity</label>
            <select id="severity-filter">
              <option value="">All Severities</option>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
              <option value="critical">Critical</option>
            </select>
          </div>

          <button id="btn-run" class="btn btn-primary" style="width: 100%;">Generate Report</button>
          <div id="run-status" class="status-message mt-2 hidden"></div>
        </div>
      </div>

      <!-- Main Content -->
      <div>
        <!-- Export Controls -->
        <div class="card mb-2">
          <div class="card-body">
            <div class="flex-between">
              <div class="card-title">Export Options</div>
              <div class="flex gap-1">
                <button id="btn-columns" class="btn btn-outline">Manage Columns</button>
                <button id="btn-excel" class="btn btn-secondary">Export to Excel</button>
                <button id="btn-pdf" class="btn btn-primary">Generate PDF Report</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Incidents by Month</div>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="chart-month"></canvas>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Incidents by Location</div>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="chart-loc"></canvas>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Incidents by Type</div>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="chart-type"></canvas>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Severity Distribution</div>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="chart-severity"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Data Table -->
        <div class="card data-section">
          <div class="card-header">
            <div class="card-title">Report Data</div>
            <div class="flex gap-1">
              <span id="row-count" class="text-muted">0 records</span>
            </div>
          </div>
          <div class="card-body">
            <div class="table-wrapper">
              <table id="data-table">
                <thead id="table-head">
                  <!-- Will be populated dynamically -->
                </thead>
                <tbody id="table-body">
                  <!-- Will be populated dynamically -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Column Selection Modal -->
<div id="modal-columns" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Manage Columns</div>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <p class="text-muted mb-2">Select which columns to display in the table:</p>
      <div id="column-list">
        <!-- Will be populated dynamically -->
      </div>
    </div>
    <div class="modal-footer">
      <button id="btn-select-all" class="btn btn-outline">Select All</button>
      <button id="btn-deselect-all" class="btn btn-outline">Deselect All</button>
      <button id="btn-apply-columns" class="btn btn-primary">Apply</button>
    </div>
  </div>
</div>

<!-- PDF Options Modal -->
<div id="modal-pdf" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">PDF Report Options</div>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <p class="text-muted mb-2">Select which charts to include in the PDF report:</p>
      <div class="column-toggle">
        <input type="checkbox" id="pdf-chart-month" checked>
        <label for="pdf-chart-month">Incidents by Month</label>
      </div>
      <div class="column-toggle">
        <input type="checkbox" id="pdf-chart-loc" checked>
        <label for="pdf-chart-loc">Incidents by Location</label>
      </div>
      <div class="column-toggle">
        <input type="checkbox" id="pdf-chart-type" checked>
        <label for="pdf-chart-type">Incidents by Type</label>
      </div>
      <div class="column-toggle">
        <input type="checkbox" id="pdf-chart-severity" checked>
        <label for="pdf-chart-severity">Severity Distribution</label>
      </div>
      
      <div class="mt-3">
        <label for="pdf-title">Report Title</label>
        <input type="text" id="pdf-title" value="Safety Report" placeholder="Enter report title">
      </div>
      
      <div class="mt-2">
        <label for="pdf-notes">Additional Notes</label>
        <textarea id="pdf-notes" rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;" placeholder="Add any additional notes or comments"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button id="btn-cancel-pdf" class="btn btn-outline">Cancel</button>
      <button id="btn-generate-pdf" class="btn btn-primary">Generate PDF</button>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbx4bjXO_KbjxcDCdHiDm9gOXT2Qywk3CSZSjP4cQkkhJ92hvG_ioXoyznF7gJ4uornH/exec"; 
const STORAGE_KEY = "arbor_safety_token_v2";

/* ===== STATE ===== */
let state = {
  token: null,
  user: null,
  role: null,
  allowed: "*",
  last: { headers: [], rows: [], rawData: [] },
  charts: { month: null, loc: null, type: null, severity: null },
  visibleColumns: [],
  filters: {
    formType: "employee_first",
    dateFrom: null,
    dateTo: null,
    location: "",
    status: "",
    severity: ""
  }
};

/* ===== UTIL ===== */
const $ = sel => document.querySelector(sel);
function show(id){ 
  $("#view-login").classList.add("hidden"); 
  $("#view-dash").classList.add("hidden"); 
  $(id).classList.remove("hidden"); 
}

function setStatus(el, msg, type = "error") {
  if (!msg) {
    el.classList.add("hidden");
    return;
  }
  
  el.textContent = msg;
  el.classList.remove("hidden", "status-error", "status-success");
  el.classList.add(type === "error" ? "status-error" : "status-success");
}

function formatDate(date) {
  const d = new Date(date);
  return d.toISOString().split('T')[0];
}

function groupBy(arr, keyFn) {
  const m = new Map();
  for (const r of arr) {
    const k = keyFn(r);
    m.set(k, (m.get(k) || 0) + 1);
  }
  return [...m.entries()].sort((a, b) => a[0] > b[0] ? 1 : -1);
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

/* ===== AUTH ===== */
function loadSession() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const obj = JSON.parse(raw);
    state.token = obj.token;
    state.user = obj.user;
    state.role = obj.role;
    state.allowed = obj.allowed;
  } catch(e) {
    console.error("Failed to load session:", e);
  }
}

function saveSession() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    token: state.token, 
    user: state.user, 
    role: state.role, 
    allowed: state.allowed
  }));
}

function clearSession() {
  localStorage.removeItem(STORAGE_KEY);
  state.token = null;
  state.user = null;
  state.role = null;
  state.allowed = "*";
}

/* ===== RENDER ===== */
function paintUser() {
  const badge = $("#user-badge");
  const logoutBtn = $("#btn-logout");
  
  if (state.user) {
    badge.classList.remove("hidden");
    logoutBtn.classList.remove("hidden");
    $("#user-name").textContent = state.user;
    $("#user-role").textContent = `• ${state.role}`;
  } else {
    badge.classList.add("hidden");
    logoutBtn.classList.add("hidden");
  }
}

/* ===== API ===== */
async function apiPost(route, payload) {
  const r = await fetch(`${ENDPOINT}?route=${encodeURIComponent(route)}`, {
    method: "POST",
    body: JSON.stringify(payload || {})
  });

  const txt = await r.text();
  try { 
    return JSON.parse(txt); 
  } catch { 
    return { ok: false, error: "Bad JSON", raw: txt }; 
  }
}

/* ===== LOGIN FLOW ===== */
async function doLogin() {
  const u = $("#login-user").value.trim();
  const p = $("#login-pass").value;
  const status = $("#login-status");
  
  if (!u || !p) { 
    setStatus(status, "Please enter both username and password."); 
    return; 
  }
  
  setStatus(status, "Signing in...", "success");
  $("#btn-login").disabled = true;

  try {
    const res = await apiPost('login', { username: u, password: p });
    if (res && res.ok) {
      state.token = res.token; 
      state.user = u; 
      state.role = res.role || "user"; 
      state.allowed = res.allowed || "*";
      
      saveSession(); 
      paintUser();
      show("#view-dash");
      initDates();
      setStatus(status, "");
    } else {
      setStatus(status, res && res.error ? `Login failed: ${res.error}` : "Login failed.");
    }
  } catch(e) {
    setStatus(status, "Network error. Please try again.");
  } finally {
    $("#btn-login").disabled = false;
  }
}

/* ===== REPORT FLOW ===== */
function initDates() {
  const today = new Date();
  const oneMonthAgo = new Date();
  oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
  
  $("#date-from").value = formatDate(oneMonthAgo);
  $("#date-to").value = formatDate(today);
}

async function runReport() {
  const status = $("#run-status");
  setStatus(status, "Loading report data...", "success");
  $("#btn-run").disabled = true;

  const form_type = $("#form-type").value;
  const date_from = $("#date-from").value || null;
  const date_to = $("#date-to").value || null;
  const location = $("#location-filter").value;
  const statusFilter = $("#status-filter").value;
  const severity = $("#severity-filter").value;

  try {
    const res = await apiPost('list', { 
      token: state.token, 
      form: form_type,
      from: date_from, 
      to: date_to
    });

    if (!res || !res.ok) {
      setStatus(status, (res && res.error) ? res.error : "Error loading report.");
      return;
    }

    // Store raw data for filtering
    state.last.headers = res.header || res.headers || [];
    state.last.rawData = res.rows || [];
    
    // Apply filters
    let filteredData = state.last.rawData;
    
    if (location) {
      filteredData = filteredData.filter(row => 
        row.location && row.location.toLowerCase().includes(location.toLowerCase())
      );
    }
    
    if (statusFilter) {
      filteredData = filteredData.filter(row => 
        row.status && row.status.toLowerCase() === statusFilter.toLowerCase()
      );
    }
    
    if (severity) {
      filteredData = filteredData.filter(row => 
        row.severity && row.severity.toLowerCase() === severity.toLowerCase()
      );
    }
    
    // Convert to array format for table
    state.last.rows = filteredData.map(obj => 
      state.last.headers.map(h => obj[h] ?? '')
    );

    // Initialize visible columns if not set
    if (state.visibleColumns.length === 0) {
      state.visibleColumns = [...state.last.headers];
    }
    
    // Update location filter options
    updateLocationFilter();
    
    drawTable();
    drawCharts();
    setStatus(status, `Report loaded with ${filteredData.length} records`, "success");
  } catch(e) {
    setStatus(status, "Network error while loading report.");
  } finally {
    $("#btn-run").disabled = false;
  }
}

function updateLocationFilter() {
  const locationFilter = $("#location-filter");
  const locations = [...new Set(state.last.rawData
    .map(row => row.location)
    .filter(Boolean)
    .sort())];
  
  // Clear existing options (keeping "All Locations")
  while (locationFilter.children.length > 1) {
    locationFilter.removeChild(locationFilter.lastChild);
  }
  
  // Add location options
  locations.forEach(location => {
    const option = document.createElement("option");
    option.value = location;
    option.textContent = location;
    locationFilter.appendChild(option);
  });
}

function drawTable() {
  const thead = $("#table-head");
  const tbody = $("#table-body");
  const H = state.last.headers;
  const R = state.last.rows;
  
  $("#row-count").textContent = `${R.length} records`;
  
  // Clear table
  thead.innerHTML = "";
  tbody.innerHTML = "";
  
  if (!H.length || !R.length) {
    thead.innerHTML = "<tr><th>No data available</th></tr>";
    return;
  }
  
  // Create header with only visible columns
  const trh = document.createElement("tr");
  H.forEach((h, idx) => {
    if (state.visibleColumns.includes(h)) {
      const th = document.createElement("th");
      th.textContent = h;
      th.dataset.column = h;
      trh.appendChild(th);
    }
  });
  thead.appendChild(trh);
  
  // Create table rows with only visible columns
  R.forEach(row => {
    const tr = document.createElement("tr");
    H.forEach((h, idx) => {
      if (state.visibleColumns.includes(h)) {
        const td = document.createElement("td");
        const val = row[idx] == null ? "" : String(row[idx]);
        
        // Detect URLs and create links
        if (/^https?:\/\//i.test(val)) {
          const a = document.createElement("a");
          a.href = val;
          a.target = "_blank";
          a.textContent = "View";
          a.style.color = "var(--primary)";
          td.appendChild(a);
        } else {
          td.textContent = val;
        }
        
        tr.appendChild(td);
      }
    });
    tbody.appendChild(tr);
  });
}

function destroyChart(c) { 
  if (c) { 
    c.destroy(); 
  } 
}

function drawCharts() {
  const H = state.last.headers;
  const rawData = state.last.rawData;
  
  if (!H.length || !rawData.length) {
    destroyChart(state.charts.month);
    destroyChart(state.charts.loc);
    destroyChart(state.charts.type);
    destroyChart(state.charts.severity);
    return;
  }
  
  // Chart 1: Incidents by Month
  const dateCols = ["incident_date", "date_of_report", "injury_datetime", "accident_datetime", "date_reported", "report_date"];
  let dIdx = -1;
  for (const cand of dateCols) {
    if (H.includes(cand)) {
      dIdx = H.indexOf(cand);
      break;
    }
  }
  
  const monthCounts = dIdx > -1 ? groupBy(rawData, row => {
    const raw = String(row[H[dIdx]] || "");
    const iso = raw.length >= 10 ? raw.slice(0, 10) : raw;
    const d = new Date(iso);
    if (isNaN(d)) return "Unknown";
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
  }) : [];
  
  const ctxM = document.getElementById("chart-month").getContext("2d");
  destroyChart(state.charts.month);
  state.charts.month = new Chart(ctxM, {
    type: "bar",
    data: {
      labels: monthCounts.map(x => x[0]),
      datasets: [{ 
        label: "Records", 
        data: monthCounts.map(x => x[1]),
        backgroundColor: "rgba(26, 71, 42, 0.7)",
        borderColor: "rgba(26, 71, 42, 1)",
        borderWidth: 1
      }]
    },
    options: { 
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { display: false } 
      }, 
      scales: { 
        y: { beginAtZero: true } 
      } 
    }
  });
  
  // Chart 2: Incidents by Location
  const locCols = ["location", "work_area", "city_state_zip", "building", "exact_location"];
  let lIdx = -1;
  for (const cand of locCols) {
    if (H.includes(cand)) {
      lIdx = H.indexOf(cand);
      break;
    }
  }
  
  const locCounts = lIdx > -1 ? groupBy(rawData, row => {
    const v = String(row[H[lIdx]] || "").trim();
    return v || "Unspecified";
  }) : [];
  
  const topL = locCounts.sort((a, b) => b[1] - a[1]).slice(0, 10);
  const ctxL = document.getElementById("chart-loc").getContext("2d");
  destroyChart(state.charts.loc);
  state.charts.loc = new Chart(ctxL, {
    type: "bar",
    data: {
      labels: topL.map(x => x[0]),
      datasets: [{ 
        label: "Records", 
        data: topL.map(x => x[1]),
        backgroundColor: "rgba(64, 145, 108, 0.7)",
        borderColor: "rgba(64, 145, 108, 1)",
        borderWidth: 1
      }]
    },
    options: { 
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y', 
      plugins: { 
        legend: { display: false } 
      }, 
      scales: { 
        x: { beginAtZero: true } 
      } 
    }
  });
  
  // Chart 3: Incidents by Type
  const typeCols = ["incident_type", "type", "category", "form_type"];
  let tIdx = -1;
  for (const cand of typeCols) {
    if (H.includes(cand)) {
      tIdx = H.indexOf(cand);
      break;
    }
  }
  
  const typeCounts = tIdx > -1 ? groupBy(rawData, row => {
    const v = String(row[H[tIdx]] || "").trim();
    return v || "Unspecified";
  }) : [];
  
  const ctxT = document.getElementById("chart-type").getContext("2d");
  destroyChart(state.charts.type);
  state.charts.type = new Chart(ctxT, {
    type: "doughnut",
    data: {
      labels: typeCounts.map(x => x[0]),
      datasets: [{ 
        label: "Records", 
        data: typeCounts.map(x => x[1]),
        backgroundColor: [
          "rgba(26, 71, 42, 0.7)",
          "rgba(64, 145, 108, 0.7)",
          "rgba(82, 183, 136, 0.7)",
          "rgba(149, 213, 178, 0.7)",
          "rgba(195, 231, 211, 0.7)"
        ],
        borderColor: [
          "rgba(26, 71, 42, 1)",
          "rgba(64, 145, 108, 1)",
          "rgba(82, 183, 136, 1)",
          "rgba(149, 213, 178, 1)",
          "rgba(195, 231, 211, 1)"
        ],
        borderWidth: 1
      }]
    },
    options: { 
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          position: 'right'
        } 
      }
    }
  });
  
  // Chart 4: Severity Distribution
  const severityCols = ["severity", "severity_level", "risk_level"];
  let sIdx = -1;
  for (const cand of severityCols) {
    if (H.includes(cand)) {
      sIdx = H.indexOf(cand);
      break;
    }
  }
  
  const severityCounts = sIdx > -1 ? groupBy(rawData, row => {
    const v = String(row[H[sIdx]] || "").trim();
    return v || "Unspecified";
  }) : [];
  
  const ctxS = document.getElementById("chart-severity").getContext("2d");
  destroyChart(state.charts.severity);
  state.charts.severity = new Chart(ctxS, {
    type: "pie",
    data: {
      labels: severityCounts.map(x => x[0]),
      datasets: [{ 
        label: "Records", 
        data: severityCounts.map(x => x[1]),
        backgroundColor: [
          "rgba(40, 167, 69, 0.7)",   // Green for low
          "rgba(255, 193, 7, 0.7)",   // Yellow for medium
          "rgba(253, 126, 20, 0.7)",  // Orange for high
          "rgba(220, 53, 69, 0.7)"    // Red for critical
        ],
        borderColor: [
          "rgba(40, 167, 69, 1)",
          "rgba(255, 193, 7, 1)",
          "rgba(253, 126, 20, 1)",
          "rgba(220, 53, 69, 1)"
        ],
        borderWidth: 1
      }]
    },
    options: { 
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          position: 'right'
        } 
      }
    }
  });
}

/* ===== COLUMN MANAGEMENT ===== */
function showColumnModal() {
  const modal = $("#modal-columns");
  const columnList = $("#column-list");
  
  columnList.innerHTML = "";
  
  state.last.headers.forEach(column => {
    const div = document.createElement("div");
    div.className = "column-toggle";
    
    const input = document.createElement("input");
    input.type = "checkbox";
    input.id = `col-${column}`;
    input.checked = state.visibleColumns.includes(column);
    
    const label = document.createElement("label");
    label.htmlFor = `col-${column}`;
    label.textContent = column;
    
    div.appendChild(input);
    div.appendChild(label);
    columnList.appendChild(div);
  });
  
  modal.classList.remove("hidden");
}

function applyColumnSelection() {
  const checkboxes = document.querySelectorAll('#column-list input[type="checkbox"]');
  state.visibleColumns = [];
  
  checkboxes.forEach(cb => {
    if (cb.checked) {
      const column = cb.id.replace('col-', '');
      state.visibleColumns.push(column);
    }
  });
  
  drawTable();
  $("#modal-columns").classList.add("hidden");
}

function selectAllColumns() {
  const checkboxes = document.querySelectorAll('#column-list input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = true);
}

function deselectAllColumns() {
  const checkboxes = document.querySelectorAll('#column-list input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = false);
}

/* ===== EXPORTS ===== */
function exportToExcel() {
  if (!state.last.headers.length || !state.last.rows.length) {
    alert("No data to export.");
    return;
  }
  
  // Create worksheet with only visible columns
  const visibleHeaders = state.last.headers.filter(h => state.visibleColumns.includes(h));
  const visibleData = state.last.rows.map(row => {
    const visibleRow = [];
    state.last.headers.forEach((h, idx) => {
      if (state.visibleColumns.includes(h)) {
        visibleRow.push(row[idx]);
      }
    });
    return visibleRow;
  });
  
  const ws = XLSX.utils.aoa_to_sheet([visibleHeaders, ...visibleData]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Safety Report");
  
  // Generate filename
  const form = $("#form-type").options[$("#form-type").selectedIndex].text.replace(/\s+/g, '_');
  const date = new Date().toISOString().slice(0, 10);
  const filename = `Safety_Report_${form}_${date}.xlsx`;
  
  XLSX.writeFile(wb, filename);
}

function showPdfModal() {
  $("#modal-pdf").classList.remove("hidden");
}

function generatePdf() {
  // In a real implementation, you would use a library like jsPDF or html2pdf
  // For this example, we'll just use the browser's print function
  // and hide the elements that shouldn't be in the PDF
  
  const title = $("#pdf-title").value || "Safety Report";
  const notes = $("#pdf-notes").value;
  
  // Show a temporary message
  const status = $("#run-status");
  setStatus(status, "Generating PDF report...", "success");
  
  // In a real implementation, you would:
  // 1. Create a new window or iframe
  // 2. Build the PDF content with selected charts
  // 3. Use a library to generate the PDF
  
  // For now, we'll just print the page
  setTimeout(() => {
    window.print();
    setStatus(status, "PDF generation complete", "success");
  }, 1000);
  
  $("#modal-pdf").classList.add("hidden");
}

/* ===== BOOT ===== */
function boot() {
  // Wire UI events
  $("#btn-login").addEventListener("click", doLogin);
  $("#login-pass").addEventListener("keydown", e => { 
    if (e.key === "Enter") doLogin(); 
  });
  
  $("#btn-run").addEventListener("click", runReport);
  $("#btn-columns").addEventListener("click", showColumnModal);
  $("#btn-excel").addEventListener("click", exportToExcel);
  $("#btn-pdf").addEventListener("click", showPdfModal);
  
  $("#btn-logout").addEventListener("click", () => {
    clearSession(); 
    paintUser(); 
    show("#view-login");
  });
  
  // Modal events
  $("#modal-columns .modal-close").addEventListener("click", () => {
    $("#modal-columns").classList.add("hidden");
  });
  
  $("#btn-apply-columns").addEventListener("click", applyColumnSelection);
  $("#btn-select-all").addEventListener("click", selectAllColumns);
  $("#btn-deselect-all").addEventListener("click", deselectAllColumns);
  
  $("#modal-pdf .modal-close").addEventListener("click", () => {
    $("#modal-pdf").classList.add("hidden");
  });
  
  $("#btn-cancel-pdf").addEventListener("click", () => {
    $("#modal-pdf").classList.add("hidden");
  });
  
  $("#btn-generate-pdf").addEventListener("click", generatePdf);
  
  // Filter change events (debounced to avoid too many API calls)
  const debouncedRunReport = debounce(runReport, 500);
  $("#location-filter").addEventListener("change", debouncedRunReport);
  $("#status-filter").addEventListener("change", debouncedRunReport);
  $("#severity-filter").addEventListener("change", debouncedRunReport);
  
  // Initialize
  loadSession();
  paintUser();
  
  if (state.token) { 
    show("#view-dash"); 
    initDates();
  } else { 
    show("#view-login"); 
  }
}

// Start the application
boot();
</script>

</body>
</html>
