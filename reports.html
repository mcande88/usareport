<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Premium Safety Reports • ArborGen</title>
  <link rel="icon" type="image/png" href="icon.png" />
  <style>
    /* Premium Color Palette (Inspired by professional dashboards) */
    :root{
      --primary-color: #007bff; /* Blue for primary actions */
      --primary-dark: #0056b3;
      --secondary-color: #6c757d; /* Gray for secondary elements */
      --success-color: #28a745; /* Green for success/positive */
      --danger-color: #dc3545; /* Red for danger/incidents */
      --bg-light: #f8f9fa; /* Light background */
      --bg-card: #ffffff; /* White card background */
      --text-dark: #212529; /* Dark text */
      --text-muted: #6c757d; /* Muted text */
      --border-color: #dee2e6; /* Light border */
      --shadow-light: 0 0.5rem 1rem rgba(0, 0, 0, 0.05); /* Subtle shadow */
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background:var(--bg-light); color:var(--text-dark); line-height:1.6; }
    a{ color:var(--primary-color); text-decoration:none }
    a:hover{ text-decoration:underline }
    .wrap{ max-width:1400px; margin:0 auto; padding:0 20px }
    
    /* Header */
    header{ background:var(--primary-color); color:#fff; box-shadow:var(--shadow-light); }
    header .bar{ display:flex; align-items:center; justify-content:space-between; padding:15px 0 }
    header h1{ margin:0; font-size:20px; font-weight:600; letter-spacing:.5px }
    header .actions{ display:flex; gap:15px; align-items:center }
    header .pill{ background:rgba(255,255,255,.15); padding:6px 10px; border-radius:999px; font-size:12px; font-weight:500; }
    header button{ border:1px solid rgba(255,255,255,.35); background:transparent; color:#fff; padding:8px 15px; border-radius:8px; cursor:pointer; transition:background 0.2s }
    header button:hover{ background:rgba(255,255,255,.12) }

    /* Main Layout */
    main{ padding:30px 0 50px }
    .card{ background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; box-shadow:var(--shadow-light); padding:20px; transition:transform 0.2s; }
    .card:hover{ transform:translateY(-2px); box-shadow:0 1rem 2rem rgba(0, 0, 0, 0.1); }
    .grid{ display:grid; gap:20px }
    .grid-2{ grid-template-columns: 1fr 1fr }
    .grid-3{ grid-template-columns: 1fr 1fr 1fr }
    @media (max-width:1200px){ .grid-2{ grid-template-columns:1fr } }
    @media (max-width:768px){ .grid-3{ grid-template-columns:1fr } }

    .panel{ display:grid; grid-template-columns: 300px 1fr; gap:20px }
    @media (max-width:1024px){ .panel{ grid-template-columns:1fr } }

    /* Sidebar */
    .side{ display:flex; flex-direction:column; gap:20px }
    .side .group{ padding:15px; border:1px solid var(--border-color); border-radius:10px; background:var(--bg-card); }
    .side h3{ margin:0 0 15px; font-size:14px; color:var(--primary-color); font-weight:700; text-transform:uppercase; border-bottom:2px solid var(--border-color); padding-bottom:10px; }
    label{ font-size:13px; color:var(--text-dark); margin-bottom:5px; display:block; font-weight:500; }
    select,input[type="text"],input[type="date"],input[type="password"]{ width:100%; padding:10px 12px; border:1px solid var(--border-color); border-radius:8px; font-size:14px; background:#fff; transition:border-color 0.2s; }
    select:focus,input:focus{ border-color:var(--primary-color); outline:none; box-shadow:0 0 0 3px rgba(0, 123, 255, 0.25); }
    
    /* Buttons */
    button{ width:100%; padding:10px; border:none; border-radius:8px; font-size:14px; cursor:pointer; transition:background 0.2s, box-shadow 0.2s; font-weight:600; }
    button.primary{ background:var(--primary-color); color:#fff; }
    button.primary:hover{ background:var(--primary-dark); box-shadow:0 4px 8px rgba(0, 123, 255, 0.3); }
    button.ghost{ background:var(--bg-card); color:var(--primary-color); border:1px solid var(--primary-color); }
    button.ghost:hover{ background:var(--bg-light); }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .muted{ color:var(--text-muted) }
    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .toolbar button{ width:auto; padding:8px 15px; }
    
    /* Table */
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:12px 15px; border-bottom:1px solid var(--border-color); font-size:14px; vertical-align:middle; }
    th{ text-align:left; color:var(--text-dark); background:var(--bg-light); position:sticky; top:0; font-weight:600; text-transform:uppercase; font-size:12px; }
    .table-wrap{ overflow:auto; max-height:600px; border:1px solid var(--border-color); border-radius:10px; }
    .status{ font-size:13px; color:var(--text-muted) }
    .center{ text-align:center }
    
    /* Login */
    .loginbox{ max-width:400px; margin:70px auto; }
    .brand{ display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .brand .dot{ width:15px; height:15px; background:var(--primary-color); border-radius:4px }
    .title{ margin:0 0 25px; font-size:24px; color:var(--text-dark); font-weight:600; }

    /* Checkbox/Switch Styling for Chart Selection */
    .switch-group { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .switch-group label { margin-bottom: 0; font-weight: normal; }
    .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary-color); }
    input:focus + .slider { box-shadow: 0 0 1px var(--primary-color); }
    input:checked + .slider:before { transform: translateX(16px); }
    
    /* Print Styles for PDF Export */
    @media print {
      body { background: #fff; }
      header, .side, .toolbar, .status, .card:hover { display: none !important; }
      .wrap { max-width: none; padding: 0; }
      main { padding: 0; }
      .panel { grid-template-columns: 1fr !important; gap: 0; }
      .card { border: none; box-shadow: none; border-radius: 0; padding: 0; margin-bottom: 20px; page-break-inside: avoid; }
      .table-wrap { overflow: visible !important; max-height: none !important; border: 1px solid #000; border-radius: 0; }
      table { width: 100%; }
      th, td { border: 1px solid #000; padding: 8px; }
      th { background: #eee !important; color: #000 !important; -webkit-print-color-adjust: exact; }
      .chart-container { width: 100%; height: 400px; margin-bottom: 20px; }
      .chart-container:not(.print-include) { display: none !important; }
    }
  </style>
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header>
  <div class="wrap bar">
    <h1>ArborGen • Premium Safety Reports</h1>
    <div class="actions">
      <span id="who" class="pill" style="display:none"></span>
      <button id="btn-logout" style="display:none">Sign out</button>
    </div>
  </div>
</header>

<main class="wrap" id="app">
  <!-- Login -->
  <div id="view-login" class="loginbox card" style="display:none">
    <div class="brand"><div class="dot"></div><strong>Nursery Safety</strong></div>
    <h2 class="title">Sign in to Reports</h2>
    <div class="grid">
      <div>
        <label>Username</label>
        <input id="login-user" autocomplete="username" />
      </div>
      <div>
        <label>Password</label>
        <input id="login-pass" type="password" autocomplete="current-password" />
      </div>
      <button id="btn-login" class="primary">Sign in</button>
      <p id="login-status" class="status"></p>
      <p class="muted">Use your ArborGen reporting credentials. Access is logged for audit purposes.</p>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="view-dash" style="display:none">
    <div class="panel">
      <div class="side">
        <!-- Report Scope -->
        <div class="group">
          <h3>Report Scope</h3>
          <label>Form Type</label>
          <select id="form-type">
            <option value="employee_first">Employee Incident</option>
            <option value="supervisor_investigation">Supervisor Investigation</option>
            <option value="vehicle_accident">Motor Vehicle Accident</option>
            <option value="non_company_injury">Non-Company Injury</option>
            <option value="near_miss">Near-Miss Report</option>
          </select>
          <div class="row" style="margin-top:15px">
            <div>
              <label>From Date</label>
              <input type="date" id="date-from">
            </div>
            <div>
              <label>To Date</label>
              <input type="date" id="date-to">
            </div>
          </div>
          <button class="primary" id="btn-run" style="margin-top:20px">Run Report</button>
          <p id="run-status" class="status"></p>
        </div>

        <!-- Data Filters (New Advanced Filtering) -->
        <div class="group">
          <h3>Data Filters</h3>
          <label>Location Keyword</label>
          <input type="text" id="filter-location" placeholder="e.g., 'Nursery A' or 'Warehouse'">
          
          <label style="margin-top:10px">Status/Outcome</label>
          <select id="filter-status">
            <option value="">All Statuses</option>
            <option value="open">Open</option>
            <option value="closed">Closed</option>
            <option value="pending">Pending Review</option>
          </select>
          
          <label style="margin-top:10px">Minimum Severity Score</label>
          <input type="number" id="filter-severity" min="0" max="10" placeholder="e.g., 5">
        </div>

        <!-- Export Options -->
        <div class="group">
          <h3>Export Options</h3>
          
          <label>PDF Chart Selection</label>
          <div class="switch-group">
            <label for="chart-month-toggle">Records by Month Chart</label>
            <label class="switch">
              <input type="checkbox" id="chart-month-toggle" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="switch-group">
            <label for="chart-loc-toggle">Top Locations Chart</label>
            <label class="switch">
              <input type="checkbox" id="chart-loc-toggle" checked>
              <span class="slider"></span>
            </label>
          </div>
          
          <label style="margin-top:15px">CSV/Excel Column Visibility</label>
          <button class="ghost" id="btn-col-visibility">Select Columns (0 selected)</button>
          
          <div class="toolbar" style="margin-top:15px">
            <button class="primary" id="btn-csv">Download CSV</button>
            <button class="primary" id="btn-pdf">Print / PDF</button>
          </div>
          <p class="status">Exports include current data filters and column selection.</p>
        </div>
      </div>

      <!-- Report Content -->
      <div>
        <div class="grid grid-2">
          <div class="card chart-container print-include" id="chart-month-card">
            <canvas id="chart-month"></canvas>
          </div>
          <div class="card chart-container print-include" id="chart-loc-card">
            <canvas id="chart-loc"></canvas>
          </div>
        </div>

        <div class="card" style="margin-top:20px">
          <div class="toolbar" style="justify-content:space-between; margin-bottom:10px">
            <strong id="table-title">Filtered Results</strong>
            <span class="status" id="count"></span>
          </div>
          <div class="table-wrap">
            <table id="tbl"><thead></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Column Visibility Modal (Simple placeholder for now) -->
<div id="col-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div class="card" style="width:400px; max-height:80vh; overflow-y:auto;">
    <h3 style="margin-top:0;">Select Columns for Export</h3>
    <div id="col-list">
      <!-- Checkboxes will be inserted here by JS -->
    </div>
    <button class="primary" id="btn-close-modal" style="margin-top:20px;">Apply Selection</button>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbx4bjXO_KbjxcDCdHiDm9gOXT2Qywk3CSZSjP4cQkkhJ92hvG_ioXoyznF7gJ4uornH/exec"; 
const STORAGE_KEY = "arbor_safety_token_v2"; // Updated key for new version

/* ===== STATE ===== */
let state = {
  token: null,
  user: null,
  role: null,
  allowed: "*",
  last: { headers: [], rows: [] }, // Raw data from API
  filtered: { headers: [], rows: [] }, // Data after applying client-side filters
  charts: { month:null, loc:null },
  columnVisibility: {} // { 'column_name': true/false }
};

/* ===== UTIL ===== */
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
function show(id){ 
  $("#view-login").style.display="none"; 
  $("#view-dash").style.display="none"; 
  $(id).style.display="block"; 
}
function setStatus(el, msg){ el.textContent = msg || ""; }

/* group by helpers */
function groupBy(arr, keyFn){
  const m = new Map();
  for (const r of arr){
    const k = keyFn(r);
    m.set(k, (m.get(k)||0)+1);
  }
  return [...m.entries()].sort((a,b)=>a[0]>b[0]?1:-1);
}

/**
 * Premium CSV Export: Handles column visibility and ensures Excel-friendly output.
 * @param {string[]} headers - The full list of column headers.
 * @param {any[][]} rows - The full list of data rows.
 * @param {Object} visibility - Map of column name to boolean visibility.
 * @returns {string} The CSV content.
 */
function toCSV(headers, rows, visibility){
  // 1. Filter headers and get indices of visible columns
  const visibleHeaders = [];
  const visibleIndices = [];
  headers.forEach((h, i) => {
    if (visibility[h] !== false) { // Default to visible if not explicitly false
      visibleHeaders.push(h);
      visibleIndices.push(i);
    }
  });

  // 2. Escape function for Excel compatibility (handling quotes and newlines)
  const esc = v => {
    const str = String(v ?? '').replace(/\r?\n/g, ' '); // Remove newlines
    return `"${str.replace(/"/g,'""')}"`; // Double quotes and wrap in quotes
  };

  // 3. Generate header row
  const head = visibleHeaders.map(esc).join(",");

  // 4. Generate data rows, only including visible columns
  const body = rows.map(row => {
    const visibleRow = visibleIndices.map(i => row[i]);
    return visibleRow.map(esc).join(",");
  }).join("\n");

  // Add BOM for better Excel compatibility (UTF-8)
  return "\ufeff" + head + "\n" + body;
}

function download(filename, content, mime="text/plain"){
  const blob = new Blob([content], {type:mime});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* ===== AUTH (Same as original) ===== */
function loadSession(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const obj = JSON.parse(raw);
    state.token = obj.token;
    state.user = obj.user;
    state.role = obj.role;
    state.allowed = obj.allowed;
  }catch{}
}
function saveSession(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    token: state.token, user: state.user, role: state.role, allowed: state.allowed
  }));
}
function clearSession(){
  localStorage.removeItem(STORAGE_KEY);
  state.token=null; state.user=null; state.role=null; state.allowed="*";
}

/* ===== RENDER (Same as original, but updated IDs) ===== */
function paintUser(){
  const who = $("#who"), out = $("#btn-logout");
  if(state.user){
    who.style.display="inline-block";
    out.style.display="inline-block";
    who.textContent = `${state.user} • ${state.role}`;
  }else{
    who.style.display="none";
    out.style.display="none";
  }
}

/* ===== API (Same as original) ===== */
async function apiPost(route, payload){
  const r = await fetch(`${ENDPOINT}?route=${encodeURIComponent(route)}`, {
    method: "POST",
    body: JSON.stringify(payload || {})
  });

  const txt = await r.text();
  try { return JSON.parse(txt); } catch { return { ok:false, error:"Bad JSON", raw:txt }; }
}

/* ===== LOGIN FLOW (Same as original) ===== */
async function doLogin(){
  const u = $("#login-user").value.trim();
  const p = $("#login-pass").value;
  const status = $("#login-status");
  if(!u || !p){ setStatus(status,"Enter username and password."); return; }
  setStatus(status,"Signing in...");
  $("#btn-login").disabled = true;

  try{
    const res = await apiPost('login', { username: u, password: p });
    if(res && res.ok){
      state.token = res.token; state.user = u; state.role = res.role || "user"; state.allowed = res.allowed || "*";
      saveSession(); paintUser();
      show("#view-dash");
      initDates();
      setStatus(status,"");
    }else{
      setStatus(status, res && res.error ? `Login failed: ${res.error}` : "Login failed.");
    }
  }catch(e){
    setStatus(status,"Network error.");
  }finally{
    $("#btn-login").disabled = false;
  }
}

/* ===== REPORT FLOW (Updated to include filtering) ===== */
function initDates(){
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  const to = `${yyyy}-${mm}-${dd}`;
  const frdate = new Date(today); frdate.setMonth(frdate.getMonth()-1);
  const fmm = String(frdate.getMonth()+1).padStart(2,'0');
  const fdd = String(frdate.getDate()).padStart(2,'0');
  const fr = `${frdate.getFullYear()}-${fmm}-${fdd}`;
  $("#date-from").value = fr;
  $("#date-to").value = to;
}

async function runReport(){
  const status = $("#run-status");
  setStatus(status,"Loading...");
  $("#btn-run").disabled = true;

  const form_type = $("#form-type").value;
  const date_from = $("#date-from").value || null;
  const date_to   = $("#date-to").value || null;

  try{
    // 1. Call API to get raw data
    const res = await apiPost('list', { 
      token: state.token, 
      form: form_type,
      from: date_from, 
      to:   date_to 
    });

    if (!res || !res.ok){
      setStatus(status, (res && res.error) ? res.error : "Error loading report.");
      return;
    }

    // 2. Store raw data
    state.last.headers = res.header || res.headers || [];
    // Convert objects to array of arrays for easier client-side processing
    state.last.rows = (res.rows || []).map(obj => state.last.headers.map(h => obj[h] ?? ''));
    
    // 3. Initialize column visibility if first run
    if (Object.keys(state.columnVisibility).length === 0) {
      state.last.headers.forEach(h => state.columnVisibility[h] = true);
      updateColumnModalButton();
    }

    // 4. Apply client-side filters
    applyClientFilters();

    setStatus(status,"Report loaded successfully.");
  }catch(e){
    setStatus(status,"Network error.");
  }finally{
    $("#btn-run").disabled = false;
  }
}

/**
 * Applies client-side filters to the raw data (state.last) and updates state.filtered.
 */
function applyClientFilters(){
  const H = state.last.headers;
  const R = state.last.rows;
  
  const locFilter = $("#filter-location").value.trim().toLowerCase();
  const statusFilter = $("#filter-status").value.trim().toLowerCase();
  const severityFilter = parseInt($("#filter-severity").value) || 0;

  // Guess indices for filtering
  const locIdx = H.findIndex(h => ["location", "work_area", "exact_location"].includes(h));
  const statusIdx = H.findIndex(h => ["status", "outcome"].includes(h));
  const severityIdx = H.findIndex(h => ["severity_score", "risk_level"].includes(h));

  const filteredRows = R.filter(row => {
    let pass = true;

    // Location Filter
    if (locFilter && locIdx > -1) {
      const val = String(row[locIdx] || '').toLowerCase();
      if (!val.includes(locFilter)) {
        pass = false;
      }
    }

    // Status Filter
    if (pass && statusFilter && statusIdx > -1) {
      const val = String(row[statusIdx] || '').toLowerCase();
      if (val !== statusFilter) {
        pass = false;
      }
    }
    
    // Severity Filter
    if (pass && severityFilter > 0 && severityIdx > -1) {
      const val = parseInt(row[severityIdx]) || 0;
      if (val < severityFilter) {
        pass = false;
      }
    }

    return pass;
  });

  state.filtered.headers = H;
  state.filtered.rows = filteredRows;

  drawTable();
  drawCharts();
}

// Attach filter change listeners
$$('.side input[type="text"], .side input[type="number"], .side select').forEach(el => {
  el.addEventListener('change', () => {
    if (state.last.rows.length > 0) {
      applyClientFilters();
    }
  });
});


/* ===== DRAW TABLE (Uses filtered data) ===== */
function drawTable(){
  const thead = $("#tbl thead"), tbody = $("#tbl tbody");
  const H = state.filtered.headers, R = state.filtered.rows;
  $("#table-title").textContent = `Filtered Results (${R.length} of ${state.last.rows.length} total)`;
  $("#count").textContent = `${R.length} rows`;
  thead.innerHTML = ""; tbody.innerHTML = "";
  if(!H.length){ thead.innerHTML = "<tr><th>No data</th></tr>"; return; }

  const trh = document.createElement("tr");
  for(const h of H){
    const th = document.createElement("th"); th.textContent = h.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); trh.appendChild(th);
  }
  thead.appendChild(trh);

  for(const row of R){
    const tr = document.createElement("tr");
    row.forEach((val, idx)=>{
      const td = document.createElement("td");
      const v = val==null ? "" : String(val);
      if(/^https?:\/\//i.test(v)){
        const a = document.createElement("a"); a.href=v; a.target="_blank"; a.textContent="Open Link";
        td.appendChild(a);
      }else{
        td.textContent = v;
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
}

/* ===== DRAW CHARTS (Uses filtered data) ===== */
function destroyChart(c){ if(c){ c.destroy(); } }
function drawCharts(){
  const H = state.filtered.headers, R = state.filtered.rows;
  
  destroyChart(state.charts.month); 
  destroyChart(state.charts.loc); 
  
  if(!H.length || !R.length){ 
    $("#chart-month-card").style.display = 'none';
    $("#chart-loc-card").style.display = 'none';
    return; 
  }
  
  $("#chart-month-card").style.display = 'block';
  $("#chart-loc-card").style.display = 'block';

  // guess date column
  const dateCols = ["incident_date","date_of_report","injury_datetime","accident_datetime","date_reported","report_date"];
  let dIdx = -1;
  for(const cand of dateCols){ const i = H.indexOf(cand); if(i>-1){ dIdx=i; break; } }
  // guess location column
  const locCols = ["location","work_area","city_state_zip","building","exact_location"];
  let lIdx = -1;
  for(const cand of locCols){ const i = H.indexOf(cand); if(i>-1){ lIdx=i; break; } }

  // --- Month Chart Data ---
  const monthCounts = dIdx>-1 ? groupBy(R, r=>{
    const raw = String(r[dIdx]||"");
    const iso = raw.length>=10 ? raw.slice(0,10) : raw;
    const d = new Date(iso);
    if(isNaN(d)) return "Unknown";
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  }) : [];

  const ctxM = document.getElementById("chart-month").getContext("2d");
  state.charts.month = new Chart(ctxM, {
    type: "bar",
    data: {
      labels: monthCounts.map(x=>x[0]),
      datasets: [{ 
        label: "Records by Month", 
        data: monthCounts.map(x=>x[1]),
        backgroundColor: 'rgba(0, 123, 255, 0.7)',
        borderColor: 'rgba(0, 123, 255, 1)',
        borderWidth: 1
      }]
    },
    options: { 
      responsive: true,
      plugins:{ 
        legend:{ display:false },
        title: { display: true, text: 'Records by Month', font: { size: 16 } }
      }, 
      scales:{ 
        y:{ beginAtZero:true, title: { display: true, text: 'Count' } },
        x:{ title: { display: true, text: 'Month' } }
      } 
    }
  });

  // --- Location Chart Data ---
  const locCounts = lIdx>-1 ? groupBy(R, r=>{
    const v = String(r[lIdx]||"").trim();
    return v || "Unspecified";
  }) : [];
  const topL = locCounts.sort((a,b)=>b[1]-a[1]).slice(0,10);

  const ctxL = document.getElementById("chart-loc").getContext("2d");
  state.charts.loc = new Chart(ctxL, {
    type: "bar",
    data: {
      labels: topL.map(x=>x[0]),
      datasets: [{ 
        label: "Top Locations", 
        data: topL.map(x=>x[1]),
        backgroundColor: 'rgba(40, 167, 69, 0.7)',
        borderColor: 'rgba(40, 167, 69, 1)',
        borderWidth: 1
      }]
    },
    options: { 
      indexAxis:'y', 
      responsive: true,
      plugins:{ 
        legend:{ display:false },
        title: { display: true, text: 'Top 10 Locations', font: { size: 16 } }
      }, 
      scales:{ 
        x:{ beginAtZero:true, title: { display: true, text: 'Count' } },
        y:{ title: { display: true, text: 'Location' } }
      } 
    }
  });
}

/* ===== COLUMN VISIBILITY MODAL ===== */
function updateColumnModalButton() {
  const visibleCount = Object.values(state.columnVisibility).filter(v => v).length;
  const totalCount = state.last.headers.length;
  $("#btn-col-visibility").textContent = `Select Columns (${visibleCount} of ${totalCount} selected)`;
}

$("#btn-col-visibility").addEventListener('click', () => {
  const colList = $("#col-list");
  colList.innerHTML = '';
  
  if (state.last.headers.length === 0) {
    colList.innerHTML = '<p class="muted">Run a report first to load columns.</p>';
  } else {
    state.last.headers.forEach(h => {
      const isChecked = state.columnVisibility[h] !== false;
      const labelText = h.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      
      const div = document.createElement('div');
      div.className = 'switch-group';
      div.innerHTML = `
        <label for="col-toggle-${h}">${labelText}</label>
        <label class="switch">
          <input type="checkbox" id="col-toggle-${h}" data-col="${h}" ${isChecked ? 'checked' : ''}>
          <span class="slider"></span>
        </label>
      `;
      colList.appendChild(div);
    });
  }
  
  $("#col-modal").style.display = 'flex';
});

$("#btn-close-modal").addEventListener('click', () => {
  // Update state.columnVisibility based on modal checkboxes
  $$('#col-list input[type="checkbox"]').forEach(input => {
    const colName = input.getAttribute('data-col');
    state.columnVisibility[colName] = input.checked;
  });
  updateColumnModalButton();
  $("#col-modal").style.display = 'none';
});


/* ===== EXPORTS (Updated for premium features) ===== */
function exportCSV(){
  if(!state.filtered.headers.length){ alert("No filtered data to export."); return; }
  
  // Use raw data (state.last) for CSV export to ensure all columns are available, 
  // but apply column visibility and Excel-friendly formatting.
  const csv = toCSV(state.last.headers, state.last.rows, state.columnVisibility);
  const form = $("#form-type").options[$("#form-type").selectedIndex].text.replace(/\s+/g,'_');
  download(`Premium_Report_${form}.csv`, csv, "text/csv;charset=utf-8");
}

function exportPDF(){
  // 1. Hide/Show charts based on user selection
  const monthToggle = $("#chart-month-toggle").checked;
  const locToggle = $("#chart-loc-toggle").checked;
  
  const monthCard = $("#chart-month-card");
  const locCard = $("#chart-loc-card");
  
  monthCard.classList.toggle('print-include', monthToggle);
  locCard.classList.toggle('print-include', locToggle);
  
  // 2. Trigger print dialog
  window.print();
  
  // 3. Restore visibility (important for screen view)
  monthCard.classList.add('print-include');
  locCard.classList.add('print-include');
}

/* ===== BOOT ===== */
function boot(){
  // wire UI
  $("#btn-login").addEventListener("click", doLogin);
  $("#login-pass").addEventListener("keydown", e=>{ if(e.key==="Enter") doLogin(); });
  $("#btn-run").addEventListener("click", runReport);
  $("#btn-csv").addEventListener("click", exportCSV);
  $("#btn-pdf").addEventListener("click", exportPDF);
  $("#btn-logout").addEventListener("click", ()=>{
    clearSession(); paintUser(); show("#view-login");
  });

  loadSession();
  paintUser();

  if(state.token){ show("#view-dash"); initDates(); }
  else{ show("#view-login"); }
}
boot();
</script>

</body>
</html>
