<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ArborGen • Premium Reports</title>
  <link rel="icon" type="image/png" href="icon.png" />
  <!-- Charts & XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --ink:#0b1220; --muted:#667085; --line:#e6e8eb; --bg:#f6f7f9; --card:#ffffff;
      --brand:#0ea5a4; --brand-700:#0a8382; --ok:#16a34a; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink); background:var(--bg)}
    a{color:inherit; text-decoration:none}

    /* Layout */
    .wrap{max-width:1280px; margin:0 auto; padding:0 20px}
    header{background:linear-gradient(180deg,#0c2a2a 0%, #0d1f1f 100%); color:#fff; position:sticky; top:0; z-index:10}
    header .bar{display:flex; align-items:center; justify-content:space-between; padding:14px 0}
    header h1{margin:0; font-size:18px; letter-spacing:.3px}
    header .right{display:flex; gap:10px; align-items:center}
    .pill{background:rgba(255,255,255,.12); padding:8px 12px; border-radius:999px; font-size:12px}
    .btn{border:1px solid var(--line); background:#fff; color:var(--ink); padding:10px 12px; border-radius:10px; cursor:pointer; font-size:14px}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .btn.primary{background:var(--brand); color:#fff; border:none}
    .btn.primary:hover{background:var(--brand-700)}
    .btn.ghost{background:#fff}
    .btn.icon{display:inline-flex; gap:8px; align-items:center}

    main{padding:20px 0 60px}
    .panel{display:grid; grid-template-columns:300px 1fr; gap:16px}
    @media (max-width:1100px){.panel{grid-template-columns:1fr}}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; box-shadow:0 2px 10px rgba(15,23,42,.04); padding:16px}
    .side{display:flex; flex-direction:column; gap:14px}
    .group h3{margin:0 0 10px; font-size:13px; letter-spacing:.2px; text-transform:uppercase; color:#1f2937}
    label{font-size:13px; color:#334155; display:block; margin-bottom:6px}
    input,select{width:100%; padding:10px; border:1px solid var(--line); border-radius:10px; background:#fff; font-size:14px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .muted{color:var(--muted); font-size:13px}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    /* Grid */
    .grid{display:grid; gap:16px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:1100px){.grid-2,.grid-3{grid-template-columns:1fr}}

    /* Table */
    .table-wrap{overflow:auto; max-height:62vh; border:1px solid var(--line); border-radius:12px}
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{position:sticky; top:0; background:#f8fafc; font-size:12px; color:#0f172a; border-bottom:1px solid var(--line); padding:10px 12px; white-space:nowrap}
    tbody td{border-bottom:1px solid var(--line); padding:10px 12px; font-size:13px; vertical-align:top}
    tbody tr:nth-child(even){background:#fcfdff}
    .chip{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#eef2ff}

    /* Column manager */
    .cols{display:grid; grid-template-columns:repeat(2,1fr); gap:6px; max-height:220px; overflow:auto; border:1px dashed var(--line); padding:10px; border-radius:10px; background:#fbfcfe}
    .cols label{display:flex; align-items:center; gap:8px; font-size:12px}

    /* Chart matrix */
    .chart-card{padding:12px}
    canvas{width:100%; height:280px}

    /* Filters row */
    .filters{display:flex; gap:10px; flex-wrap:wrap}
    .filters .f{display:flex; flex-direction:column; min-width:180px}

    /* Print */
    @media print{
      body{background:#fff}
      header, .noprint{display:none !important}
      .print-area{display:block}
      .table-wrap{max-height:unset; overflow:visible}
      .card{box-shadow:none; border:none; padding:0}
      canvas{height:220px !important}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap bar">
    <h1>ArborGen • Safety Reports (Premium)</h1>
    <div class="right">
      <span id="who" class="pill" style="display:none"></span>
      <button id="btn-logout" class="btn ghost" style="display:none">Sign out</button>
    </div>
  </div>
</header>

<main class="wrap" id="app">
  <!-- Login -->
  <div id="view-login" class="card" style="max-width:440px; margin:60px auto; display:none">
    <h2 style="margin:6px 0 14px">Sign in to Reports</h2>
    <div class="row">
      <div>
        <label>Username</label>
        <input id="login-user" autocomplete="username" />
      </div>
      <div>
        <label>Password</label>
        <input id="login-pass" type="password" autocomplete="current-password" />
      </div>
    </div>
    <div class="toolbar" style="margin-top:12px">
      <button id="btn-login" class="btn primary">Sign in</button>
      <span id="login-status" class="muted"></span>
    </div>
    <p class="muted" style="margin-top:8px">Use your ArborGen reporting credentials. Access is logged for audit purposes.</p>
  </div>

  <!-- Dashboard -->
  <div id="view-dash" style="display:none">
    <div class="panel">
      <aside class="side">
        <div class="card group">
          <h3>Scope</h3>
          <label>Form</label>
          <select id="form-type">
            <option value="employee_first">Employee Incident</option>
            <option value="supervisor_investigation">Supervisor Investigation</option>
            <option value="vehicle_accident">Motor Vehicle Accident</option>
            <option value="non_company_injury">Non-Company Injury</option>
            <option value="near_miss">Near-Miss Report</option>
          </select>
          <div class="row" style="margin-top:8px">
            <div>
              <label>From</label>
              <input type="date" id="date-from">
            </div>
            <div>
              <label>To</label>
              <input type="date" id="date-to">
            </div>
          </div>
          <div class="filters" style="margin-top:10px">
            <div class="f">
              <label>Global search</label>
              <input id="global-search" placeholder="Type to filter rows…" />
            </div>
            <div class="f">
              <label>Only rows with photo/attachment</label>
              <select id="has-url">
                <option value="any">Any</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>
          <div class="toolbar" style="margin-top:12px">
            <button class="btn primary" id="btn-run">Run report</button>
            <span id="run-status" class="muted"></span>
          </div>
        </div>

        <div class="card group">
          <h3>Columns</h3>
          <div class="toolbar noprint" style="margin-bottom:6px">
            <button class="btn ghost" id="btn-cols-all">Show all</button>
            <button class="btn ghost" id="btn-cols-none">Hide all</button>
          </div>
          <div id="cols" class="cols"></div>
        </div>

        <div class="card group">
          <h3>Charts for PDF</h3>
          <div class="cols" id="chart-toggles" style="grid-template-columns:1fr">
            <label><input type="checkbox" data-chart="month" checked> Records by month</label>
            <label><input type="checkbox" data-chart="loc" checked> Top locations</label>
            <label><input type="checkbox" data-chart="type" checked> Incident types</label>
          </div>
          <p class="muted">Only checked charts will be printed/exported.</p>
        </div>

        <div class="card group">
          <h3>Export</h3>
          <div class="toolbar noprint">
            <button class="btn ghost" id="btn-csv" title="CSV with UTF‑8 BOM (Excel‑friendly)">Download CSV</button>
            <button class="btn ghost" id="btn-xlsx" title="Native Excel .xlsx with visible columns">Download XLSX</button>
            <button class="btn ghost" id="btn-pdf" title="Opens system print dialog">Print / PDF</button>
          </div>
          <p class="muted">Exports respect current filters and visible columns.</p>
        </div>
      </aside>

      <section>
        <div class="grid grid-3 noprint" id="charts-row">
          <div class="card chart-card" id="c-month"><canvas id="chart-month"></canvas></div>
          <div class="card chart-card" id="c-loc"><canvas id="chart-loc"></canvas></div>
          <div class="card chart-card" id="c-type"><canvas id="chart-type"></canvas></div>
        </div>

        <div class="card" style="margin-top:16px">
          <div class="toolbar" style="justify-content:space-between; margin-bottom:8px">
            <strong id="table-title">Results</strong>
            <span class="muted" id="count"></span>
          </div>
          <div class="table-wrap">
            <table id="tbl"><thead></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- Print selection area -->
        <div class="print-area" style="display:none">
          <h2 style="margin:0 0 8px">ArborGen • Safety Report</h2>
          <p class="muted" id="print-sub"></p>
          <div id="print-charts" class="grid grid-3" style="margin:10px 0"></div>
          <div class="table-wrap" style="margin-top:10px"><table id="print-table"><thead></thead><tbody></tbody></table></div>
        </div>
      </section>
    </div>
  </div>
</main>

<script>
/***** CONFIG *****/
const ENDPOINT = "https://script.google.com/macros/s/AKfycbx4bjXO_KbjxcDCdHiDm9gOXT2Qywk3CSZSjP4cQkkhJ92hvG_ioXoyznF7gJ4uornH/exec"; 
const STORAGE_KEY = "arbor_safety_token_v2";

/***** STATE *****/
let state = {
  token:null, user:null, role:null, allowed:"*",
  headers:[], rows:[], // rows:[ [..], .. ] raw from API
  view:{ filteredIdx:[], hiddenCols:new Set(), search:"", requireUrl:"any" },
  charts: { month:null, loc:null, type:null }
};

/***** DOM HELPERS *****/
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function show(id){ $("#view-login").style.display="none"; $("#view-dash").style.display="none"; $(id).style.display="block"; }
function setStatus(el,msg){ el.textContent = msg||""; }

/***** SESSION *****/
function loadSession(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return; Object.assign(state, JSON.parse(raw)); }catch{} }
function saveSession(){ const {token,user,role,allowed}=state; localStorage.setItem(STORAGE_KEY, JSON.stringify({token,user,role,allowed})); }
function clearSession(){ localStorage.removeItem(STORAGE_KEY); state.token=null; state.user=null; state.role=null; state.allowed="*"; }
function paintUser(){ const who=$("#who"), out=$("#btn-logout"); if(state.user){ who.style.display="inline-block"; out.style.display="inline-block"; who.textContent=`${state.user} • ${state.role||"user"}` } else { who.style.display="none"; out.style.display="none"; } }

/***** API *****/
async function apiPost(route, payload){
  const r = await fetch(`${ENDPOINT}?route=${encodeURIComponent(route)}`, { method:"POST", body: JSON.stringify(payload||{}) });
  const txt = await r.text();
  try { return JSON.parse(txt); } catch { return { ok:false, error:"Bad JSON", raw:txt }; }
}

/***** LOGIN *****/
async function doLogin(){
  const u=$("#login-user").value.trim(); const p=$("#login-pass").value; const s=$("#login-status");
  if(!u||!p){ setStatus(s,"Enter username and password."); return; }
  setStatus(s,"Signing in..."); $("#btn-login").disabled=true;
  try{
    const res = await apiPost('login', { username:u, password:p });
    if(res && res.ok){ state.token=res.token; state.user=u; state.role=res.role||"user"; state.allowed=res.allowed||"*"; saveSession(); paintUser(); show("#view-dash"); initDates(); }
    else setStatus(s, res && res.error ? `Login failed: ${res.error}` : "Login failed.");
  }catch{ setStatus(s, "Network error."); }
  finally{ $("#btn-login").disabled=false; }
}

/***** DATES *****/
function initDates(){ const t=new Date(); const yyyy=t.getFullYear(); const mm=String(t.getMonth()+1).padStart(2,'0'); const dd=String(t.getDate()).padStart(2,'0');
  $("#date-to").value=`${yyyy}-${mm}-${dd}`; const f=new Date(t); f.setMonth(f.getMonth()-1); $("#date-from").value=`${f.getFullYear()}-${String(f.getMonth()+1).padStart(2,'0')}-${String(f.getDate()).padStart(2,'0')}`; }

/***** FETCH DATA *****/
async function runReport(){
  const status=$("#run-status"); setStatus(status,"Loading..."); $("#btn-run").disabled=true;
  const form=$("#form-type").value; const from=$("#date-from").value||null; const to=$("#date-to").value||null;
  try{
    const res = await apiPost('list', { token:state.token, form, from, to });
    if(!res || !res.ok){ setStatus(status, res && res.error ? res.error : "Error loading report."); return; }
    const H = res.header || res.headers || []; const rowsObj = res.rows || [];
    state.headers=H;
    state.rows = rowsObj.map(obj => H.map(h => obj[h] ?? ''));

    // Store extra stats if server provides (optional)
    state.serverStats = await apiPost('stats', { token: state.token, form });

    buildColumnManager();
    applyFiltersAndRender();
    drawCharts();
    setStatus(status, "");
  }catch(e){ setStatus(status, "Network error."); }
  finally{ $("#btn-run").disabled=false; }
}

/***** FILTERS & VIEW *****/
function matchesSearch(row){ if(!state.view.search) return true; const q=state.view.search.toLowerCase(); return row.some(v => String(v||"").toLowerCase().includes(q)); }
function matchesUrlReq(row){
  const needs = state.view.requireUrl; if(needs==="any") return true;
  const hasUrl = row.some(v => /^https?:\/\//i.test(String(v||"")));
  return needs==="yes" ? hasUrl : !hasUrl;
}
function getFilteredIdx(){ const idx=[]; for(let i=0;i<state.rows.length;i++){ const r=state.rows[i]; if(matchesSearch(r) && matchesUrlReq(r)) idx.push(i); } return idx; }
function applyFiltersAndRender(){ state.view.filteredIdx = getFilteredIdx(); renderTable(); updateCounters(); }
function updateCounters(){ $("#count").textContent = `${state.view.filteredIdx.length} rows • ${visibleColumns().length} columns`; const formText=$("#form-type").options[$("#form-type").selectedIndex].text; $("#table-title").textContent=`Results — ${formText}`; }

/***** COLUMN MANAGER *****/
function buildColumnManager(){ const wrap=$("#cols"); wrap.innerHTML=""; state.view.hiddenCols.clear();
  state.headers.forEach((h, i)=>{
    const id = `col_${i}`; const lab=document.createElement('label');
    lab.innerHTML = `<input type="checkbox" id="${id}" checked> <span>${escapeHtml(h)}</span>`;
    wrap.appendChild(lab);
    lab.querySelector('input').addEventListener('change', e=>{ if(!e.target.checked) state.view.hiddenCols.add(i); else state.view.hiddenCols.delete(i); renderTable(); });
  });
}
function visibleColumns(){ return state.headers.map((h,i)=> i).filter(i => !state.view.hiddenCols.has(i)); }

/***** TABLE RENDER *****/
function renderTable(){ const thead=$("#tbl thead"), tbody=$("#tbl tbody"); thead.innerHTML=""; tbody.innerHTML="";
  if(!state.headers.length){ thead.innerHTML="<tr><th>No data</th></tr>"; return; }
  const V=visibleColumns();
  const trh=document.createElement('tr'); V.forEach(i=>{ const th=document.createElement('th'); th.textContent=state.headers[i]; trh.appendChild(th);}); thead.appendChild(trh);
  state.view.filteredIdx.forEach(ridx=>{
    const row=state.rows[ridx]; const tr=document.createElement('tr');
    V.forEach(i=>{ const td=document.createElement('td'); const v=row[i]==null?"":String(row[i]); if(/^https?:\/\//i.test(v)){ const a=document.createElement('a'); a.href=v; a.target="_blank"; a.textContent="open"; td.appendChild(a);} else { td.textContent=v; } tr.appendChild(td); });
    tbody.appendChild(tr);
  });
}

/***** CHARTS *****/
function destroyChart(c){ if(c){ c.destroy(); } }
function drawCharts(){ const H=state.headers, R=state.rows, idxs=state.view.filteredIdx; if(!H.length||!R.length){ [state.charts.month, state.charts.loc, state.charts.type].forEach(destroyChart); return; }
  function pick(colNames){ for(const cand of colNames){ const i=H.indexOf(cand); if(i>-1) return i; } return -1; }
  const dIdx = pick(["incident_date","date_of_report","injury_datetime","accident_datetime","date_reported","report_date"]);
  const lIdx = pick(["location","work_area","city_state_zip","building","exact_location"]);
  const tIdx = pick(["incident_type","incident_category","type","event_type"]);

  const byMonth = new Map();
  if(dIdx>-1){ idxs.forEach(ix=>{ const raw=String(R[ix][dIdx]||""); const iso=raw.length>=10?raw.slice(0,10):raw; const d=new Date(iso); const k=isNaN(d)?"Unknown": `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; byMonth.set(k,(byMonth.get(k)||0)+1); }); }
  const monthData=[...byMonth.entries()].sort((a,b)=>a[0]>b[0]?1:-1);

  const byLoc=new Map(); if(lIdx>-1){ idxs.forEach(ix=>{ const v=String(R[ix][lIdx]||"").trim()||"Unspecified"; byLoc.set(v,(byLoc.get(v)||0)+1); }); }
  const topLoc=[...byLoc.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);

  const byType=new Map(); if(tIdx>-1){ idxs.forEach(ix=>{ const v=String(R[ix][tIdx]||"").trim()||"Other"; byType.set(v,(byType.get(v)||0)+1); }); }
  const typeData=[...byType.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12);

  // Month chart
  destroyChart(state.charts.month);
  state.charts.month = new Chart($("#chart-month"), { type:"bar", data:{ labels:monthData.map(x=>x[0]), datasets:[{label:"Records by month", data:monthData.map(x=>x[1])}] }, options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }});
  // Location chart
  destroyChart(state.charts.loc);
  state.charts.loc = new Chart($("#chart-loc"), { type:"bar", data:{ labels:topLoc.map(x=>x[0]), datasets:[{label:"Top locations", data:topLoc.map(x=>x[1])}] }, options:{ indexAxis:'y', plugins:{legend:{display:false}}, scales:{x:{beginAtZero:true}} }});
  // Type chart
  destroyChart(state.charts.type);
  state.charts.type = new Chart($("#chart-type"), { type:"doughnut", data:{ labels:typeData.map(x=>x[0]), datasets:[{label:"Incident types", data:typeData.map(x=>x[1])}] }, options:{ plugins:{legend:{position:'bottom'}} }});

  // Respect chart toggles (show/hide cards)
  $$("#chart-toggles input[type=checkbox]").forEach(cb=>{
    const id=cb.dataset.chart; const card=$(`#c-${id}`); card.style.display = cb.checked?"block":"none";
  });
}

/***** EXPORTS *****/
function currentMatrix(){ const V=visibleColumns(); const header=V.map(i=>state.headers[i]); const rows = state.view.filteredIdx.map(ix => V.map(i=> state.rows[ix][i] )); return {header, rows}; }
function toCSV(header, rows){ // Excel-friendly: add BOM, use CRLF
  const esc = v => '"' + String(v??'').replace(/"/g,'""') + '"';
  const body = rows.map(r => r.map(esc).join(',')).join('\r\n');
  return '\uFEFF' + header.map(esc).join(',') + '\r\n' + body; // BOM prefix
}
function download(name, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); a.remove(); }
function exportCSV(){ if(!state.headers.length){ alert("No data to export."); return; } const {header,rows}=currentMatrix(); const csv = toCSV(header, rows); download(`Report_${dateStamp()}.csv`, new Blob([csv], {type:"text/csv;charset=utf-8"})); }
function exportXLSX(){ if(!state.headers.length){ alert("No data to export."); return; } const {header, rows}=currentMatrix(); const ws = XLSX.utils.aoa_to_sheet([header, ...rows]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Report'); const out = XLSX.write(wb, {type:'array', bookType:'xlsx'}); download(`Report_${dateStamp()}.xlsx`, new Blob([out], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})); }
function dateStamp(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

/***** PRINT / PDF *****/
function preparePrintArea(){ const sub=$("#print-sub"); const formText=$("#form-type").options[$("#form-type").selectedIndex].text; const from=$("#date-from").value||"(start)"; const to=$("#date-to").value||"(end)"; sub.textContent = `${formText} — ${from} to ${to}`;
  // charts per toggle
  const tgt=$("#print-charts"); tgt.innerHTML="";
  const chartsToPrint=[];
  $$("#chart-toggles input[type=checkbox]").forEach(cb=>{ if(!cb.checked) return; const id=cb.dataset.chart; const canvas = $(`#chart-${id}`); const img = document.createElement('img'); img.src = canvas.toDataURL('image/png'); img.style.width='100%'; img.style.height='auto'; const card=document.createElement('div'); card.className='card chart-card'; card.appendChild(img); tgt.appendChild(card); chartsToPrint.push(id); });
  // table (visible columns + filtered rows)
  const {header, rows} = currentMatrix(); const thead=$("#print-table thead"), tbody=$("#print-table tbody"); thead.innerHTML=""; tbody.innerHTML=""; const trh=document.createElement('tr'); header.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); }); thead.appendChild(trh); rows.forEach(r=>{ const tr=document.createElement('tr'); r.forEach(v=>{ const td=document.createElement('td'); const s=String(v||""); if(/^https?:\/\//i.test(s)){ const a=document.createElement('a'); a.href=s; a.textContent=s; td.appendChild(a);} else { td.textContent=s; } tr.appendChild(td); }); tbody.appendChild(tr); });
}
function exportPDF(){ preparePrintArea(); window.print(); }

/***** UTILS *****/
function escapeHtml(s){ return String(s).replace(/[&<>\"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

/***** BOOT & EVENTS *****/
function boot(){
  // Buttons
  $("#btn-login").addEventListener('click', doLogin);
  $("#login-pass").addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
  $("#btn-logout").addEventListener('click', ()=>{ clearSession(); paintUser(); show('#view-login'); });
  $("#btn-run").addEventListener('click', runReport);
  $("#btn-csv").addEventListener('click', exportCSV);
  $("#btn-xlsx").addEventListener('click', exportXLSX);
  $("#btn-pdf").addEventListener('click', exportPDF);

  // Filters
  $("#global-search").addEventListener('input', e=>{ state.view.search=e.target.value; applyFiltersAndRender(); drawCharts(); });
  $("#has-url").addEventListener('change', e=>{ state.view.requireUrl=e.target.value; applyFiltersAndRender(); drawCharts(); });

  // Column bulk
  $("#btn-cols-all").addEventListener('click', ()=>{ state.view.hiddenCols.clear(); $$("#cols input[type=checkbox]").forEach(c=>c.checked=true); renderTable(); updateCounters(); });
  $("#btn-cols-none").addEventListener('click', ()=>{ state.view.hiddenCols = new Set(state.headers.map((_,i)=>i)); $$("#cols input[type=checkbox]").forEach(c=>c.checked=false); renderTable(); updateCounters(); });

  // Chart toggles live
  $$("#chart-toggles input[type=checkbox]").forEach(cb=> cb.addEventListener('change', drawCharts));

  loadSession(); paintUser();
  if(state.token){ show('#view-dash'); initDates(); } else { show('#view-login'); }
}
boot();
</script>
</body>
</html>
